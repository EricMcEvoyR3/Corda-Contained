# Base image from (http://phusion.github.io/baseimage-docker)
FROM openjdk:8u151-jre-alpine

RUN apk upgrade --update && \
    apk add --update --no-cache bash iputils nfs-utils nss curl netcat-openbsd lftp && \
    rm -rf /var/cache/apk/* && \
    # Add user to run the app && \
    addgroup corda && \
    adduser -G corda -D -s /bin/bash corda && \
    # Create /opt/corda/netmap directory && \
	mkdir -p /opt/corda/netmap/logs && \
	mkdir -p /opt/corda/netmap/persistent

ADD --chown=corda:corda doorman.jar /opt/corda/netmap/doorman.jar
ADD --chown=corda:corda startNetmap.sh /opt/corda/netmap/startNetmap.sh
ADD --chown=corda:corda log4j2-enm.xml /opt/corda/netmap/log4j2.xml

# Permissioning
RUN chown -R corda:corda /opt/corda
RUN dos2unix /opt/corda/netmap/startNetmap.sh /opt/corda/netmap/startNetmap.sh
RUN chmod +x /opt/corda/netmap/startNetmap.sh

# Working directory for Netmap
WORKDIR /opt/corda/netmap
ENV HOME=/opt/corda/netmap
USER corda

EXPOSE 20000
EXPOSE 20001


# Start it
CMD ./startNetmap.sh